	TITLE	DTOJ (V02/L05)

;	GLOBAL	DTOJ
;	EXTERN	.CLR
;	EXTERN	.ZRC
;	EXTERN	.D10
;	EXTERN	.SL4
;	EXTERN	.M10
;	EXTERN	.SR4
;
NBASE	EQU	30H
SPACE	EQU	20H
MINUS	EQU	2DH
DP	EQU	2EH
CD	EQU	44H
BYTE	EQU	8
DBYTEC	EQU	((BYTE-1)*8-3)*3/10
;
DTOJ	EQU	$
	LD	(DSRCADR),HL
	LD	(DDSTADR),DE
	XOR	A
	LD	(DEXPD),A
	LD	DE,DWRKT
	LD	HL,(DSRCADR)
	LD	BC,BYTE-1
	LDIR
	LD	A,(HL)
	AND	7FH
	LD	(DEXPS),A
	LD	A,(HL)
	AND	80H
	LD	(DSGND),A
	XOR	A
	LD	(DE),A
	LD	HL,DWRKT
	LD	B,BYTE-1
	CALL	.ZRC
	JR	NZ,DTOJ4
	LD	HL,DEXPS
	LD	(HL),41H
DTOJ4:	LD	A,(DEXPS)
	CP	41H
	JR	C,DTOJ1
	JR	Z,DTOJ2
DTOJ3:	LD	HL,DWRKT
	LD	DE,DWRKD
	LD	B,BYTE-1
	CALL	.D10
	LD	HL,DEXPD
	INC	(HL)
	LD	A,(DWRKT+BYTE-2)
	AND	0F0H
	JR	NZ,DTOJ3
	LD	HL,DWRKT
	LD	B,BYTE-1
	CALL	.SL4
	LD	HL,DEXPS
	DEC	(HL)
	JR	DTOJ4
DTOJ1:	LD	HL,DWRKT
	LD	DE,DWRKD
	LD	B,BYTE
	CALL	.M10
	LD	HL,DEXPD
	DEC	(HL)
	LD	A,(DWRKT+BYTE-1)
	AND	A
	JR	Z,DTOJ1
	LD	HL,DWRKT+BYTE-1
	LD	B,BYTE
	CALL	.SR4
	LD	HL,DEXPS
	INC	(HL)
	JR	DTOJ4
DTOJ2:	LD	A,(DWRKT+BYTE-2)
	CP	0A0H
	JR	C,DTOJ5
	LD	HL,DWRKT
	LD	DE,DWRKD
	LD	B,BYTE-1
	CALL	.D10
	LD	HL,DEXPD
	INC	(HL)
DTOJ5:	LD	HL,(DDSTADR)
	LD	A,(DSGND)
	AND	A
	JP	Z,DTOJ6
	LD	(HL),MINUS
DTOJ61:	INC	HL
	CALL	DJCNV
	LD	(HL),DP
	INC	HL
	LD	(DDSTADR),HL
	LD	B,BYTE-1
DTOJL:	PUSH	BC
	LD	HL,DWRKT
	LD	DE,DWRKD
	LD	B,BYTE
	CALL	.M10
	LD	HL,(DDSTADR)
	CALL	DJCNV
	LD	(DDSTADR),HL
	POP	BC
	DJNZ	DTOJL
	LD	HL,(DDSTADR)
	LD	(HL),CD
	INC	HL
	LD	A,(DEXPD)
	BIT	7,A
	JR	NZ,DTOJ7
	LD	(HL),SPACE
DTOJ71:	LD	C,0
	LD	B,10
	INC	HL
DTOJ9:	SUB	B
	JR	C,DTOJ8
	INC	C
	JR	DTOJ9
DTOJ8:	ADD	A,10
	LD	B,A
	LD	A,C
	XOR	NBASE
	LD	(HL),A
	INC	HL
	LD	A,B
	XOR	NBASE
	LD	(HL),A
	INC	HL
	LD	(DDSTADR),HL
	LD	HL,DWRKT
	LD	DE,DWRKD
	LD	B,BYTE
	CALL	.M10
	LD	A,(DWRKT+BYTE-2)
	CP	50H
	JR	NC,DTOJC
DTOJR:	XOR	A
	LD	DE,(DDSTADR)
	RET
DTOJ6:	LD	(HL),SPACE
	JP	DTOJ61
DTOJ7:	LD	(HL),MINUS
	NEG
	JR	DTOJ71
DTOJC:	LD	B,DBYTEC
	LD	HL,(DDSTADR)
YY:	LD	A,(HL)
	CP	44H
	JR	Z,XX
	DEC	HL
	JR	YY
XX:	LD	B,DBYTEC
DTOJC1:	DEC	HL
DTOJC2:	LD	A,(HL)
	CP	DP
	JR	Z,DTOJC1
	INC	A
	LD	(HL),A
	CP	NBASE+10
	JR	C,DTOJR
	LD	(HL),NBASE
	DEC	HL
	DJNZ	DTOJC2
	LD	DE,(DDSTADR)
	DEC	DE
	LD	HL,(DDSTADR)
	DEC	HL
	DEC	HL
	LD	BC,DBYTEC
	LDDR
	LD	A,NBASE+1
	LD	(DE),A
	INC	DE
	LD	A,(DE)
	LD	C,A
	LD	A,DP
	LD	(DE),A
	LD	A,C
	INC	DE
	LD	(DE),A
	LD	HL,(DDSTADR)
	INC	HL
	LD	A,(HL)
	CP	SPACE
	JR	Z,DTOJC3
	INC	HL
	INC	HL
	LD	A,(HL)
	DEC	A
	LD	(HL),A
	CP	NBASE
	JR	NC,DTOJR1
	LD	(HL),NBASE+9
	DEC	HL
	DEC	(HL)
	JP	DTOJR
DTOJC3:	INC	HL
	INC	HL
	LD	A,(HL)
	INC	A
	LD	(HL),A
	CP	NBASE+10
	JP	C,DTOJR
	LD	(HL),NBASE
	DEC	HL
	INC	(HL)
	JP	DTOJR
DTOJR1:	JP	NZ,DTOJR
	DEC	HL
	LD	A,(HL)
	CP	NBASE
	JP	NZ,DTOJR
	DEC	HL
	LD	(HL),SPACE
	JP	DTOJR
;
DJCNV:	EQU	$
	LD	DE,DWRKT+BYTE-2
	LD	A,(DE)
	RRCA
	RRCA
	RRCA
	RRCA
	AND	0FH
	XOR	NBASE
	LD	(HL),A
	INC	HL
	LD	A,(DE)
	AND	0FH
	LD	(DE),A
	RET
;
DWRKT:	DEFS	BYTE
DWRKD:	DEFS	BYTE
DSGND:	DEFB	0
DEXPS:	DEFB	0
DEXPD:	DEFB	0
DSRCADR:	DEFW	0
DDSTADR:	DEFW	0
;
;	END
