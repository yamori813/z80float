	TITLE	JTOD (V02/L05)
;	GLOBAL	JTOD
;	EXTERN	.CLR
;	EXTERN	.DEC
;	EXTERN	.M10
;	EXTERN	.ADD
;	EXTERN	.STP
;	EXTERN	.ZRC
;	EXTERN	.SL4
;	EXTERN	.SR4
;	EXTERN	.RND
;	EXTERN	.D10
;
SPACE	EQU	20H
MINUS	EQU	2DH
PLUS	EQU	2BH
DP	EQU	2EH
CD	EQU	44H
CE	EQU	45H
BYTE	EQU	8
JBYTEC	EQU	((BYTE-1)*8-3)*3/10+1
SEIDO	EQU	40H OR (BYTE-1)*2
;
;	ASEG
;	ORG	300H
JTOD	EQU	$
	LD	(JSRCADR),HL
	LD	(JDSTADR),DE
	XOR	A
	LD	(JSGND),A
	LD	(JSGNS),A
	LD	(JEXPS),A
	LD	DE,JWRKT
	LD	B,BYTE+1
	CALL	.CLR
	LD	DE,JWRKS
	LD	B,BYTE
	CALL	.CLR
	LD	HL,JEXPD
	LD	(HL),SEIDO
JTOD1:	CALL	GETC
	CP	SPACE
	JR	Z,JTOD1
	CP	PLUS
	JR	Z,JTOD2
	CP	MINUS
	JR	Z,JTOD3
	CP	DP
	JR	Z,JTOD4
	CALL	.DEC
	JP	C,DERR
JTOD8:	LD	(JWRKS),A
	LD	C,A
	LD	HL,JSGNS
	LD	A,(HL)
	AND	A
	JR	NZ,JTOD5
	LD	A,C
	AND	A
	JR	Z,JTOD2
JTOD5:	INC	(HL)
	LD	HL,JWRKT+1
	LD	DE,JWRKD
	LD	B,BYTE-1
	CALL	.M10
	LD	HL,JWRKS
	LD	DE,JWRKT+1
	LD	B,BYTE
	CALL	.ADD
	LD	A,(JSGNS)
	CP	JBYTEC
	JP	NC,JTOD7
JTOD2:	CALL	GETC
	CALL	.DEC
	JR	NC,JTOD8
JTOD72:	CP	DP
	JR	Z,JTOD4
JTOD45:	CP	CD
	JP	Z,JTOD9
	CP	CE
	JP	Z,JTOD9
	CALL	.STP
	JP	Z,JTOD10
	JP	DERR
JTOD3:	LD	HL,JSGND
	LD	(HL),80H
	JR	JTOD2
JTOD4:	LD	A,(JSGNS)
	CP	JBYTEC
	JR	NC,JTOD6
	CALL	GETC
	CALL	.DEC
	JR	C,JTOD45
	LD	(JWRKS),A
	LD	C,A
	LD	HL,JSGNS
	LD	A,(HL)
	AND	A
	JR	NZ,JTOD42
	LD	A,C
	AND	A
	JR	Z,JTOD43
JTOD42:	INC	(HL)
	LD	HL,JWRKT+1
	LD	DE,JWRKD
	LD	B,BYTE-1
	CALL	.M10
	LD	HL,JWRKS
	LD	DE,JWRKT+1
	LD	B,BYTE
	CALL	.ADD
JTOD43:	LD	HL,JEXPS
	DEC	(HL)
	JR	JTOD4
JTOD6:	CALL	GETC
	CALL	.DEC
	JR	NC,JTOD6
	JP	JTOD45
JTOD7:	CALL	GETC
	CALL	.DEC
	JP	C,JTOD72
	LD	HL,JEXPS
	INC	(HL)
	JR	JTOD7
JTOD9:	XOR	A
	LD	(JWRKS),A
	LD	(JWRKS+BYTE),A
	LD	(JSGNS),A
	CALL	GETC
	CP	PLUS
	JR	JTOD91
	CP	MINUS
	JP	JTOD92
	CALL	.DEC
	JP	C,DERR
JTOD93:	LD	C,A
	LD	HL,JSGNS
	LD	A,(HL)
	AND	A
	JR	NZ,JTOD94
	LD	A,C
	AND	A
	JR	Z,JTOD91
JTOD94:	INC	(HL)
	LD	HL,JWRKS
	SLA	(HL)
	LD	A,(HL)
	SLA	(HL)
	SLA	(HL)
	ADD	A,(HL)
	ADD	A,C
	LD	(HL),A
	LD	A,(JSGNS)
	CP	3
	JR	NC,JTOD95
JTOD91:	CALL	GETC
	CALL	.DEC
	JR	NC,JTOD93
	CALL	.STP
	JR	Z,JTOD11
	JP	DERR
JTOD95:	CALL	GETC
	CALL	.STP
	JP	NZ,DERR
JTOD11:	LD	HL,JWRKS
	LD	A,(JWRKS+BYTE)
	AND	A
	JR	Z,JTOD12
	LD	A,(HL)
	NEG
	LD	(HL),A
JTOD12:	LD	DE,JEXPS
	LD	A,(DE)
	ADD	A,(HL)
	LD	(DE),A
	JP	PE,DOVF
JTOD10:	LD	HL,JWRKT+1
	LD	B,BYTE-1
	CALL	.ZRC
	JP	Z,DUNDF
JTOD13:	LD	A,(JWRKT+BYTE-1)
	AND	0F0H
	JR	NZ,JTOD14
	LD	HL,JWRKT+1
	LD	B,BYTE-1
	CALL	.SL4
	LD	HL,JEXPD
	DEC	(HL)
	JR	JTOD13
JTOD14:	XOR	A
	LD	(JWRKT+BYTE),A
	LD	A,(JEXPS)
	AND	A
	JP	M,JTOD15
	JR	Z,JTOD16
JTOD17:	LD	HL,JWRKT+1
	LD	DE,JWRKD
	LD	B,BYTE
	CALL	.M10
	LD	A,(JWRKT+BYTE)
	AND	A
	JR	Z,JTOD18
	LD	HL,JWRKT+BYTE
	LD	B,BYTE+1
	CALL	.SR4
	LD	HL,JEXPD
	LD	A,(HL)
	ADD	A,1
	JP	M,DOVF
	LD	(HL),A
JTOD18:	LD	HL,JEXPS
	DEC	(HL)
	JR	NZ,JTOD17
JTOD16:	LD	DE,JWRKT
	LD	B,BYTE+1
	CALL	.RND
	LD	A,(JWRKT+BYTE)
	AND	A
	JR	Z,JTOD19
	LD	HL,JWRKT+BYTE
	LD	B,BYTE+1
	CALL	.SR4
	LD	HL,JEXPD
	LD	A,(HL)
	ADD	A,1
	JP	M,DOVF
	LD	(HL),A
	JR	JTOD16
JTOD19:	LD	HL,JWRKT+1
	LD	DE,(JDSTADR)
	LD	BC,BYTE-1
	LDIR
	LD	A,(JEXPD)
	LD	C,A
	LD	A,(JSGND)
	XOR	C
	LD	(DE),A
	XOR	A
JTODR:	LD	HL,(JSRCADR)
	RET
JTOD92:	LD	HL,JWRKS+BYTE
	LD	(HL),80H
	JP	JTOD91
JTOD15:	LD	HL,JWRKT
	LD	DE,JWRKD
	LD	B,BYTE
	CALL	.D10
	LD	A,(JWRKT+BYTE-1)
	AND	0F0H
	JR	NZ,JTOD20
	LD	HL,JWRKT
	LD	B,BYTE
	CALL	.SL4
	LD	HL,JEXPD
	LD	A,(HL)
	SUB	1
	JP	M,DUNDF
	LD	(HL),A
JTOD20:	LD	HL,JEXPS
	INC	(HL)
	JR	NZ,JTOD15
	JP	JTOD16
DERR:	LD	A,1
	AND	A
	JR	JTODR
DOVF:	LD	A,81H
	AND	A
	JR	JTODR
DUNDF:	LD	DE,(JDSTADR)
	LD	B,BYTE
	XOR	A
	CALL	.CLR
	JR	JTODR
;
GETC:	EQU	$
	LD	HL,(JSRCADR)

	LD	A,(HL)
	INC	HL
	LD	(JSRCADR),HL
	RET
;
JWRKS:	DEFS	BYTE+1
JWRKD:	DEFS	BYTE+1
JWRKT:	DEFS	BYTE+1
JEXPS:	DEFB	00
JEXPD:	DEFB	00
JSGNS:	DEFB	00
JSGND:	DEFB	00
JSRCADR:	DEFW	0000
JDSTADR:	DEFW	0000
;
;	END
